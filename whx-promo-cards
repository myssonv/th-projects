/**
 * ============================================================================
 * WHX PROMO CARDS PRO - COMPLETE FUNCTIONS
 * ============================================================================
 * 
 * Version: 9.9.2 - Cache & URL Routing Fixes
 * Author: WHX Development Team
 *
 * CHANGES IN v9.9.2:
 * ‚úì FIXED: W3 Total Cache integration (auto-clears W3TC, WP Rocket, WP Super Cache, LiteSpeed)
 * ‚úì FIXED: Multi-product codes now default to /start with promocode persistence
 * ‚úì FIXED: URL routing respects settings routes (email ‚Üí /hosting/email works now!)
 * ‚úì NEW: Products metadata attribute for custom multi-product titles
 * ‚úì NEW: "Get 20% off our SSL, Reseller, Windows Hosting" style titles
 * ‚úì IMPROVED: Cache clearing documentation with W3TC specific instructions
 *
 * Previous v9.9.1 Features:
 * ‚úì Black Friday dark+gold styling | Products metadata titles
 * ‚úì Price override labels | Domain search in new tab
 * ‚úì Documentation tab with copy buttons
 * 
 * Installation: Replace entire WHX Promo Cards code with this file
 * Requirements: WHX WHMCS Core plugin active
 * Shortcode: [whmcs_promos]
 * ============================================================================
 */

// ============================================================================
// SECURITY: PREVENT DIRECT ACCESS
// ============================================================================
if (!defined('ABSPATH')) {
    die('Direct access not permitted');
}

// ============================================================================
// CONFIGURATION: DEBUG MODE
// ============================================================================
// Set to false in production to disable debug logging
define('WHX_PROMO_DEBUG', true);

/**
 * Debug Logger Function
 * Logs messages to error log when debug mode is active (admins only)
 */
function whx_promo_debug($message, $data = null) {
    if (!WHX_PROMO_DEBUG || !current_user_can('manage_options')) return;

    $log = '[WHX PROMO v9.9.2] ' . $message;
    if ($data !== null) {
        $log .= ' | Data: ' . print_r($data, true);
    }
    error_log($log);
}

// ============================================================================
// SECTION 1: ADMIN DASHBOARD & SETTINGS
// ============================================================================

/**
 * Register Admin Menu Page
 */
add_action('admin_menu', 'whx_promo_admin_menu');
function whx_promo_admin_menu() {
    add_submenu_page(
        'whx-whmcs-core',
        'Promo Cards',
        'Promo Cards',
        'manage_options',
        'whx-promo-cards',
        'whx_promo_settings_page'
    );
}

/**
 * Get Default Settings Configuration
 */
function whx_promo_get_default_settings() {
    return [
        // Page Routes Configuration (HYBRID SETUP - Best Practice)
        // Simple products ‚Üí Direct to WHMCS (best for promocode persistence)
        // Complex products ‚Üí WordPress landing pages (marketing content)
        'routes' => [
            // DOMAINS: Direct to WHMCS cart (simple purchase flow)
            'domains' => '/cloud/cart.php?a=add&domain=register',
            'domains_ke' => '/ke-domain', // WordPress landing (regional marketing)
            'domains_transfer' => '/cloud/cart.php?a=add&domain=transfer',
            'domains_free' => '/domains/free', // WordPress landing
            'domains_whois' => '/domains/whois', // WordPress tool
            
            // HOSTING: WordPress landing pages (needs education/comparison)
            'hosting' => '/hosting',
            'hosting_cpanel' => '/hosting/cpanel',
            'hosting_cyberpanel' => '/hosting/cyberpanel',
            'hosting_windows' => '/hosting/windows',
            'hosting_reseller' => '/hosting/reseller',
            'hosting_free' => '/hosting/free',
            'hosting_dedicated' => '/hosting/dedicated-servers',
            'hosting_email' => '/hosting/email',
            
            // VPS: Direct to WHMCS store (technical users, less hand-holding)
            'vps' => '/cloud/store/vps-hosting',
            'vps_managed' => '/cloud/store/managed-vps',
            
            // SSL: Direct to WHMCS (simple purchase)
            'ssl' => '/cloud/store/ssl-certificates',
            
            // OTHER SERVICES: WordPress landing pages (marketing content)
            'ai_builder' => '/ai-website-builder',
            'online_store' => '/online-store',
            'seo' => '/local-seo',
            
            // WHMCS FALLBACKS
            'whmcs_cart' => '/cloud/cart.php',
            'whmcs_store' => '/cloud/store',
        ],
        
        // Badge Display Configuration
        'badges' => [
            'hot_threshold' => 40,
            'ending_soon_days' => 7,
            'enable_category_badge' => true,
            'enable_hot_badge' => true,
            'enable_ending_soon_badge' => true,
            'enable_expired_badge' => true,
        ],
        
        // Cache Configuration
        'cache' => [
            'enable_cache' => false, // Disabled by default for instant updates
            'promos_ttl' => 5,
            'products_ttl' => 30,
            'tlds_ttl' => 30,
        ],
        
        // Pricing Configuration
        'pricing' => [
            'auto_detect' => true,
            'preferred_cycle' => 'annually',
            'show_pricing' => true,
            'show_domain_pricing' => true,
        ],
    ];
}

/**
 * Get Current Settings (Merges saved with defaults)
 */
function whx_promo_get_settings() {
    $defaults = whx_promo_get_default_settings();
    $saved = get_option('whx_promo_settings', []);
    return array_replace_recursive($defaults, $saved);
}

/**
 * AJAX Handler: Clear Cache
 */
add_action('wp_ajax_whx_clear_promo_cache', 'whx_ajax_clear_promo_cache');
function whx_ajax_clear_promo_cache() {
    check_ajax_referer('whx_promo_cache_nonce', 'nonce');
    
    if (!current_user_can('manage_options')) {
        wp_send_json_error(['message' => 'Unauthorized']);
        return;
    }
    
    whx_clear_promo_cache();
    wp_send_json_success(['message' => 'Cache cleared successfully!']);
}

/**
 * Render Admin Settings Page
 */
function whx_promo_settings_page() {
    if (!current_user_can('manage_options')) return;
    
    // Handle Form Submission
    if (isset($_POST['whx_promo_save_settings']) && check_admin_referer('whx_promo_settings')) {
        $settings = whx_promo_get_default_settings();
        
        // Save Routes
        if (isset($_POST['routes'])) {
            foreach ($_POST['routes'] as $key => $value) {
                $settings['routes'][$key] = sanitize_text_field($value);
            }
        }
        
        // Save Badge Settings
        if (isset($_POST['badges'])) {
            $settings['badges']['hot_threshold'] = absint($_POST['badges']['hot_threshold']);
            $settings['badges']['ending_soon_days'] = absint($_POST['badges']['ending_soon_days']);
            $settings['badges']['enable_category_badge'] = isset($_POST['badges']['enable_category_badge']);
            $settings['badges']['enable_hot_badge'] = isset($_POST['badges']['enable_hot_badge']);
            $settings['badges']['enable_ending_soon_badge'] = isset($_POST['badges']['enable_ending_soon_badge']);
            $settings['badges']['enable_expired_badge'] = isset($_POST['badges']['enable_expired_badge']);
        }
        
        // Save Cache Settings
        if (isset($_POST['cache'])) {
            $settings['cache']['enable_cache'] = isset($_POST['cache']['enable_cache']);
            $settings['cache']['promos_ttl'] = absint($_POST['cache']['promos_ttl']);
            $settings['cache']['products_ttl'] = absint($_POST['cache']['products_ttl']);
            $settings['cache']['tlds_ttl'] = absint($_POST['cache']['tlds_ttl']);
        }
        
        // Save Pricing Settings
        if (isset($_POST['pricing'])) {
            $settings['pricing']['auto_detect'] = isset($_POST['pricing']['auto_detect']);
            $settings['pricing']['show_pricing'] = isset($_POST['pricing']['show_pricing']);
            $settings['pricing']['show_domain_pricing'] = isset($_POST['pricing']['show_domain_pricing']);
            $settings['pricing']['preferred_cycle'] = sanitize_text_field($_POST['pricing']['preferred_cycle']);
        }
        
        update_option('whx_promo_settings', $settings);
        whx_clear_promo_cache();
        
        echo '<div class="notice notice-success is-dismissible"><p><strong>‚úì Settings saved and cache cleared!</strong></p></div>';
    }
    
    $settings = whx_promo_get_settings();
    $cache_nonce = wp_create_nonce('whx_promo_cache_nonce');
    ?>
    <div class="wrap">
        <h1>üéüÔ∏è WHX Promo Cards - v9.9.2</h1>
        
        <?php if (WHX_PROMO_DEBUG): ?>
        <div style="background:#fef3c7;padding:15px;margin:20px 0;border-radius:8px;border-left:4px solid #f59e0b;">
            <p><strong>‚ö†Ô∏è DEBUG MODE ACTIVE</strong> - Check error logs for detailed promo card information</p>
        </div>
        <?php endif; ?>
        
        <!-- CACHE MANAGEMENT SECTION -->
        <div style="background:#fff;padding:20px;margin:20px 0;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
            <h2>‚ö° Cache Management</h2>
            <p class="description">Clear the promo cache to see changes immediately.</p>
            <div style="margin-top:15px;">
                <button type="button" id="whx-clear-cache-btn" class="button button-secondary" data-nonce="<?php echo esc_attr($cache_nonce); ?>">
                    üßπ Clear Cache Now
                </button>
                <span id="whx-cache-message" style="margin-left:15px;font-weight:600;"></span>
            </div>
        </div>
        
        <form method="post" action="">
            <?php wp_nonce_field('whx_promo_settings'); ?>
            
            <!-- PRICING SETTINGS SECTION -->
            <div style="background:#fff;padding:20px;margin:20px 0;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
                <h2>üí∞ Automatic Pricing Detection</h2>
                <p class="description">Automatically pull pricing from WHMCS products and calculate discounted prices.</p>
                <table class="form-table">
                    <tr>
                        <th style="width:250px;">Enable Auto Pricing</th>
                        <td>
                            <label><input type="checkbox" name="pricing[auto_detect]" <?php checked($settings['pricing']['auto_detect']); ?>> Automatically detect and display product pricing</label>
                            <p class="description">When enabled, prices are pulled from WHMCS products automatically</p>
                        </td>
                    </tr>
                    <tr>
                        <th>Show Product Pricing</th>
                        <td>
                            <label><input type="checkbox" name="pricing[show_pricing]" <?php checked($settings['pricing']['show_pricing']); ?>> Display pricing on product promo cards</label>
                            <p class="description">Show/hide the pricing section on hosting/VPS/SSL cards</p>
                        </td>
                    </tr>
                    <tr>
                        <th>Show Domain Pricing</th>
                        <td>
                            <label><input type="checkbox" name="pricing[show_domain_pricing]" <?php checked($settings['pricing']['show_domain_pricing']); ?>> Display pricing on domain promo cards</label>
                            <p class="description">Show/hide registration prices for domain promos</p>
                        </td>
                    </tr>
                    <tr>
                        <th>Preferred Billing Cycle</th>
                        <td>
                            <select name="pricing[preferred_cycle]">
                                <option value="monthly" <?php selected($settings['pricing']['preferred_cycle'], 'monthly'); ?>>Monthly</option>
                                <option value="quarterly" <?php selected($settings['pricing']['preferred_cycle'], 'quarterly'); ?>>Quarterly</option>
                                <option value="semiannually" <?php selected($settings['pricing']['preferred_cycle'], 'semiannually'); ?>>Semi-Annually</option>
                                <option value="annually" <?php selected($settings['pricing']['preferred_cycle'], 'annually'); ?>>Annually (Recommended)</option>
                                <option value="biennially" <?php selected($settings['pricing']['preferred_cycle'], 'biennially'); ?>>Biennially</option>
                                <option value="triennially" <?php selected($settings['pricing']['preferred_cycle'], 'triennially'); ?>>Triennially</option>
                            </select>
                            <p class="description">Which billing cycle to show (annual is most common)</p>
                        </td>
                    </tr>
                </table>
            </div>
            
            <!-- CACHE SETTINGS SECTION -->
            <div style="background:#fff;padding:20px;margin:20px 0;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
                <h2>‚ö° Cache Settings</h2>
                <p class="description" style="background:#fef3c7;padding:10px;border-radius:5px;border-left:3px solid #f59e0b;">
                    <strong>üí° Tip:</strong> If you frequently update promos in WHMCS, disable caching or set to 1-2 minutes for instant updates.
                </p>
                <p class="description" style="background:#e7f3ff;padding:10px;border-radius:5px;border-left:3px solid #0891b2;margin-top:10px;">
                    <strong>üîå Third-Party Cache Plugins Detected:</strong> Our cache clearing now supports:
                    <br>‚Ä¢ <strong>W3 Total Cache</strong> - Auto-cleared when you click "Clear Cache Now"
                    <br>‚Ä¢ <strong>WP Super Cache</strong> - Auto-cleared
                    <br>‚Ä¢ <strong>WP Rocket</strong> - Auto-cleared
                    <br>‚Ä¢ <strong>LiteSpeed Cache</strong> - Auto-cleared
                    <br><em>URLs and prices will update immediately after clearing!</em>
                </p>
                <p class="description" style="background:#fee;padding:10px;border-radius:5px;border-left:3px solid #dc3545;margin-top:10px;">
                    <strong>‚ö†Ô∏è Prices or URLs not updating?</strong> If changes don't appear after clearing cache:
                    <br>1. Click <strong>"Clear Cache Now"</strong> button above (clears ALL caches)
                    <br>2. If using W3 Total Cache, also flush from: Performance ‚Üí Dashboard ‚Üí Empty All Caches
                    <br>3. Try <strong>disabling cache completely</strong> (uncheck below) for instant updates
                    <br>4. Refresh your promo page (Ctrl+F5 for hard refresh)
                    <br><br><strong>üí° URL Settings:</strong> Changes to routes (like /hosting/email) require cache clearing to take effect!
                </p>
                <table class="form-table">
                    <tr>
                        <th style="width:250px;"><strong>Enable Caching</strong></th>
                        <td>
                            <label>
                                <input type="checkbox" name="cache[enable_cache]" <?php checked($settings['cache']['enable_cache']); ?>>
                                <strong>Use cached data (faster, but changes take time to appear)</strong>
                            </label>
                            <p class="description">
                                <span style="color:#059669;">‚úì Checked = Cache ON (faster page loads, recommended for production)</span><br>
                                <span style="color:#dc2626;">‚úó Unchecked = Cache OFF (instant updates, good for testing/frequent changes)</span>
                            </p>
                        </td>
                    </tr>
                    <tr>
                        <th>Promotions Cache</th>
                        <td>
                            <input type="number" name="cache[promos_ttl]" value="<?php echo esc_attr($settings['cache']['promos_ttl']); ?>" class="small-text" min="1"> minutes
                            <p class="description">Recommended: 5 minutes</p>
                        </td>
                    </tr>
                    <tr>
                        <th>Products Cache</th>
                        <td>
                            <input type="number" name="cache[products_ttl]" value="<?php echo esc_attr($settings['cache']['products_ttl']); ?>" class="small-text" min="1"> minutes
                            <p class="description">Recommended: 30 minutes</p>
                        </td>
                    </tr>
                    <tr>
                        <th>TLDs Cache</th>
                        <td>
                            <input type="number" name="cache[tlds_ttl]" value="<?php echo esc_attr($settings['cache']['tlds_ttl']); ?>" class="small-text" min="1"> minutes
                            <p class="description">Recommended: 30 minutes</p>
                        </td>
                    </tr>
                </table>
            </div>
            
            <!-- PAGE ROUTES SECTION -->
            <div style="background:#fff;padding:20px;margin:20px 0;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
                <h2>üîó Page Routes</h2>
                <p class="description">Configure destination URLs. Use relative paths like /domains or full URLs.</p>
                
                <table class="form-table">
                    <tr><th colspan="2"><h3 style="margin:10px 0 5px;">Domain Pages</h3></th></tr>
                    <?php
                    $route_labels = [
                        'domains' => 'General Domains',
                        'domains_ke' => '.KE Domains',
                        'domains_transfer' => 'Domain Transfer',
                        'domains_free' => 'Free Domains',
                        'domains_whois' => 'WHOIS Lookup',
                    ];
                    foreach ($route_labels as $key => $label): ?>
                        <tr>
                            <th style="width:250px;"><?php echo esc_html($label); ?></th>
                            <td><input type="text" name="routes[<?php echo $key; ?>]" value="<?php echo esc_attr($settings['routes'][$key]); ?>" class="regular-text"></td>
                        </tr>
                    <?php endforeach; ?>
                    
                    <tr><th colspan="2"><h3 style="margin:20px 0 5px;">Hosting Pages</h3></th></tr>
                    <?php
                    $hosting_routes = [
                        'hosting' => 'General Hosting',
                        'hosting_cpanel' => 'cPanel Hosting',
                        'hosting_cyberpanel' => 'CyberPanel Hosting',
                        'hosting_windows' => 'Windows Hosting',
                        'hosting_reseller' => 'Reseller Hosting',
                        'hosting_free' => 'Free Hosting',
                        'hosting_dedicated' => 'Dedicated Servers',
                        'hosting_email' => 'Email Hosting',
                    ];
                    foreach ($hosting_routes as $key => $label): ?>
                        <tr>
                            <th><?php echo esc_html($label); ?></th>
                            <td><input type="text" name="routes[<?php echo $key; ?>]" value="<?php echo esc_attr($settings['routes'][$key]); ?>" class="regular-text"></td>
                        </tr>
                    <?php endforeach; ?>
                    
                    <tr><th colspan="2"><h3 style="margin:20px 0 5px;">VPS & Services</h3></th></tr>
                    <?php
                    $other_routes = [
                        'vps' => 'VPS Hosting',
                        'vps_managed' => 'Managed VPS',
                        'ssl' => 'SSL Certificates',
                        'ai_builder' => 'AI Website Builder',
                        'online_store' => 'Online Store',
                        'seo' => 'Local SEO',
                        'whmcs_cart' => 'WHMCS Cart',
                        'whmcs_store' => 'WHMCS Store',
                    ];
                    foreach ($other_routes as $key => $label): ?>
                        <tr>
                            <th><?php echo esc_html($label); ?></th>
                            <td><input type="text" name="routes[<?php echo $key; ?>]" value="<?php echo esc_attr($settings['routes'][$key]); ?>" class="regular-text"></td>
                        </tr>
                    <?php endforeach; ?>
                </table>
            </div>
            
            <!-- BADGE SETTINGS SECTION -->
            <div style="background:#fff;padding:20px;margin:20px 0;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
                <h2>üè∑Ô∏è Badge Settings</h2>
                <table class="form-table">
                    <tr>
                        <th style="width:250px;">Hot Badge Threshold</th>
                        <td>
                            <input type="number" name="badges[hot_threshold]" value="<?php echo esc_attr($settings['badges']['hot_threshold']); ?>" class="small-text" min="0" max="100">%
                            <p class="description">Show "LIMITED" badge when discount ‚â• this %</p>
                        </td>
                    </tr>
                    <tr>
                        <th>Ending Soon Days</th>
                        <td>
                            <input type="number" name="badges[ending_soon_days]" value="<?php echo esc_attr($settings['badges']['ending_soon_days']); ?>" class="small-text" min="1" max="30"> days
                            <p class="description">Show "ENDING SOON" badge when expiring within X days</p>
                        </td>
                    </tr>
                    <tr>
                        <th>Enable Badges</th>
                        <td>
                            <label style="display:block;margin:5px 0;"><input type="checkbox" name="badges[enable_category_badge]" <?php checked($settings['badges']['enable_category_badge']); ?>> Category Badge</label>
                            <label style="display:block;margin:5px 0;"><input type="checkbox" name="badges[enable_hot_badge]" <?php checked($settings['badges']['enable_hot_badge']); ?>> LIMITED Badge</label>
                            <label style="display:block;margin:5px 0;"><input type="checkbox" name="badges[enable_ending_soon_badge]" <?php checked($settings['badges']['enable_ending_soon_badge']); ?>> ENDING SOON Badge</label>
                            <label style="display:block;margin:5px 0;"><input type="checkbox" name="badges[enable_expired_badge]" <?php checked($settings['badges']['enable_expired_badge']); ?>> EXPIRED Badge</label>
                        </td>
                    </tr>
                </table>
            </div>
            
            <?php submit_button('üíæ Save All Settings', 'primary large', 'whx_promo_save_settings'); ?>
        </form>
        
        <!-- VERSION INFO SECTION -->
        <div style="background:#f0fdf4;padding:15px;margin:20px 0;border-radius:8px;border-left:4px solid #10b981;">
            <p><strong>Shortcode:</strong> <code>[whmcs_promos]</code> <em>(See documentation tab above for all options)</em></p>
            <p><strong>Version:</strong> 9.9.2 - Cache & URL Routing Fixes</p>
            <p><strong>What's New in v9.9.2:</strong></p>
            <ul style="margin:10px 0 0 20px;">
                <li>üîå <strong>W3 Total Cache:</strong> Auto-clears W3TC, WP Rocket, WP Super Cache, and LiteSpeed Cache</li>
                <li>üîó <strong>URL Routing Fixed:</strong> Email promos now correctly route to /hosting/email (respects your settings!)</li>
                <li>üéØ <strong>Multi-Product Codes:</strong> Automatically link to /start with promocode when multiple products</li>
                <li>üìù <strong>Products Metadata:</strong> Add <code>"products": "SSL, Reseller, Windows Hosting"</code> for custom titles</li>
                <li>‚ú® <strong>Better Titles:</strong> "Get 20% off our SSL, Reseller and Windows Hosting Plans"</li>
            </ul>
            <p style="margin-top:10px;"><strong>Previous Features (v9.9.1):</strong></p>
            <ul style="margin:5px 0 0 20px;">
                <li>‚úÖ Black Friday dark+gold styling (auto-detects BF codes)</li>
                <li>‚úÖ Price override labels show actual prices</li>
                <li>‚úÖ Domain search opens in new tab</li>
                <li>‚úÖ Documentation tab with copy buttons</li>
                <li>‚úÖ Mobile-first design (70% mobile users!)</li>
            </ul>
            <p style="margin-top:10px;"><strong>üéØ Recommended:</strong> Clear cache after changing routes | Use /start for multi-product promos | Add products metadata for custom titles</p>
        </div>
        
        <!-- WORDPRESS BRIDGE SCRIPT -->
        <div style="background:#fffbeb;padding:15px;margin:20px 0;border-radius:8px;border-left:4px solid #f59e0b;">
            <h3 style="margin-top:0;">üåâ WordPress Promocode Bridge (Optional)</h3>
            <p>If you send users to <strong>WordPress landing pages</strong> (e.g., /hosting, /domains), add this code to your theme's footer to persist promocodes:</p>
            <details style="margin:10px 0;">
                <summary style="cursor:pointer;font-weight:bold;padding:5px;">Click to View JavaScript Code</summary>
                <pre style="background:#fff;padding:15px;border:1px solid #ddd;border-radius:4px;overflow-x:auto;margin-top:10px;"><code>&lt;!-- Add to WordPress theme footer (functions.php or footer.php) --&gt;
&lt;script&gt;
(function() {
    // Capture promocode from URL
    var urlParams = new URLSearchParams(window.location.search);
    var promocode = urlParams.get('promocode');
    
    if (promocode) {
        // Store with 7-day expiry
        var expiry = new Date().getTime() + (7 * 24 * 60 * 60 * 1000);
        localStorage.setItem('whx_promocode', promocode);
        localStorage.setItem('whx_promocode_expiry', expiry);
        console.log('[WHX] Promocode captured:', promocode);
    }
    
    // Add promocode to all WHMCS links on page
    document.addEventListener('DOMContentLoaded', function() {
        var stored = localStorage.getItem('whx_promocode');
        var expiry = localStorage.getItem('whx_promocode_expiry');
        
        // Check if expired (7 days)
        if (stored && expiry && new Date().getTime() < parseInt(expiry)) {
            // Add to all links pointing to /cloud
            document.querySelectorAll('a[href*="/cloud"]').forEach(function(link) {
                var href = link.getAttribute('href');
                if (href && href.indexOf('promocode=') === -1) {
                    var separator = href.indexOf('?') !== -1 ? '&' : '?';
                    link.setAttribute('href', href + separator + 'promocode=' + encodeURIComponent(stored));
                }
            });
            
            console.log('[WHX] Promocode applied to WHMCS links:', stored);
        } else if (expiry && new Date().getTime() >= parseInt(expiry)) {
            // Clean up expired
            localStorage.removeItem('whx_promocode');
            localStorage.removeItem('whx_promocode_expiry');
        }
    });
})();
&lt;/script&gt;</code></pre>
            </details>
            <p><strong>üìç Where to add:</strong> WordPress Admin ‚Üí Appearance ‚Üí Theme File Editor ‚Üí footer.php (before &lt;/body&gt;)</p>
            <p><strong>‚úÖ What it does:</strong> Captures promocode from URL, stores for 7 days, auto-applies to all WHMCS links</p>
            <p><strong>üí° Recommendation:</strong> Use <strong>WP Code Lite</strong> plugin for easier code injection (Header & Footer section)</p>
        </div>

        <!-- SHORTCODE DOCUMENTATION TAB -->
        <div style="background:#fff;padding:20px;margin:20px 0;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
            <h2>üìö Shortcode Documentation & Examples</h2>
            <p class="description">Copy and paste these shortcodes directly into your WordPress pages, posts, or widgets.</p>

            <div style="margin-top:20px;">
                <h3 style="color:#0891b2;margin-bottom:10px;">üéØ Basic Usage</h3>
                <div style="background:#f8fafc;padding:15px;border-radius:6px;margin-bottom:20px;position:relative;">
                    <button onclick="navigator.clipboard.writeText('[whmcs_promos]')" style="position:absolute;top:10px;right:10px;padding:5px 12px;background:#0891b2;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">üìã Copy</button>
                    <code style="display:block;font-size:14px;color:#1e293b;">[whmcs_promos]</code>
                    <p style="margin:10px 0 0;font-size:13px;color:#64748b;">Displays all active promotions</p>
                </div>

                <h3 style="color:#0891b2;margin-bottom:10px;">üé® Filter by Category</h3>
                <div style="background:#f8fafc;padding:15px;border-radius:6px;margin-bottom:15px;position:relative;">
                    <button onclick="navigator.clipboard.writeText('[whmcs_promos type=&quot;domains&quot;]')" style="position:absolute;top:10px;right:10px;padding:5px 12px;background:#0891b2;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">üìã Copy</button>
                    <code style="display:block;font-size:14px;color:#1e293b;">[whmcs_promos type="domains"]</code>
                    <p style="margin:10px 0 0;font-size:13px;color:#64748b;">Show only domain promotions</p>
                </div>
                <div style="background:#f8fafc;padding:15px;border-radius:6px;margin-bottom:15px;position:relative;">
                    <button onclick="navigator.clipboard.writeText('[whmcs_promos type=&quot;hosting&quot;]')" style="position:absolute;top:10px;right:10px;padding:5px 12px;background:#0891b2;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">üìã Copy</button>
                    <code style="display:block;font-size:14px;color:#1e293b;">[whmcs_promos type="hosting"]</code>
                    <p style="margin:10px 0 0;font-size:13px;color:#64748b;">Show only hosting promotions</p>
                </div>
                <div style="background:#f8fafc;padding:15px;border-radius:6px;margin-bottom:15px;position:relative;">
                    <button onclick="navigator.clipboard.writeText('[whmcs_promos type=&quot;vps&quot;]')" style="position:absolute;top:10px;right:10px;padding:5px 12px;background:#0891b2;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">üìã Copy</button>
                    <code style="display:block;font-size:14px;color:#1e293b;">[whmcs_promos type="vps"]</code>
                    <p style="margin:10px 0 0;font-size:13px;color:#64748b;">Show only VPS promotions</p>
                </div>

                <h3 style="color:#0891b2;margin-bottom:10px;">üî¢ Sorting Options</h3>
                <div style="background:#f8fafc;padding:15px;border-radius:6px;margin-bottom:15px;position:relative;">
                    <button onclick="navigator.clipboard.writeText('[whmcs_promos sort=&quot;discount_desc&quot;]')" style="position:absolute;top:10px;right:10px;padding:5px 12px;background:#0891b2;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">üìã Copy</button>
                    <code style="display:block;font-size:14px;color:#1e293b;">[whmcs_promos sort="discount_desc"]</code>
                    <p style="margin:10px 0 0;font-size:13px;color:#64748b;">Sort by highest discount first</p>
                </div>
                <div style="background:#f8fafc;padding:15px;border-radius:6px;margin-bottom:15px;position:relative;">
                    <button onclick="navigator.clipboard.writeText('[whmcs_promos sort=&quot;expiry_asc&quot;]')" style="position:absolute;top:10px;right:10px;padding:5px 12px;background:#0891b2;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">üìã Copy</button>
                    <code style="display:block;font-size:14px;color:#1e293b;">[whmcs_promos sort="expiry_asc"]</code>
                    <p style="margin:10px 0 0;font-size:13px;color:#64748b;">Sort by expiring soon first</p>
                </div>
                <div style="background:#f8fafc;padding:15px;border-radius:6px;margin-bottom:15px;position:relative;">
                    <button onclick="navigator.clipboard.writeText('[whmcs_promos sort=&quot;display_order&quot;]')" style="position:absolute;top:10px;right:10px;padding:5px 12px;background:#0891b2;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">üìã Copy</button>
                    <code style="display:block;font-size:14px;color:#1e293b;">[whmcs_promos sort="display_order"]</code>
                    <p style="margin:10px 0 0;font-size:13px;color:#64748b;">Sort by custom display order (set in promo notes)</p>
                </div>

                <h3 style="color:#0891b2;margin-bottom:10px;">‚öôÔ∏è Advanced Options</h3>
                <div style="background:#f8fafc;padding:15px;border-radius:6px;margin-bottom:15px;position:relative;">
                    <button onclick="navigator.clipboard.writeText('[whmcs_promos show_expired=&quot;no&quot;]')" style="position:absolute;top:10px;right:10px;padding:5px 12px;background:#0891b2;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">üìã Copy</button>
                    <code style="display:block;font-size:14px;color:#1e293b;">[whmcs_promos show_expired="no"]</code>
                    <p style="margin:10px 0 0;font-size:13px;color:#64748b;">Hide expired promotions</p>
                </div>
                <div style="background:#f8fafc;padding:15px;border-radius:6px;margin-bottom:15px;position:relative;">
                    <button onclick="navigator.clipboard.writeText('[whmcs_promos max_items=&quot;6&quot;]')" style="position:absolute;top:10px;right:10px;padding:5px 12px;background:#0891b2;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">üìã Copy</button>
                    <code style="display:block;font-size:14px;color:#1e293b;">[whmcs_promos max_items="6"]</code>
                    <p style="margin:10px 0 0;font-size:13px;color:#64748b;">Limit to 6 promotions</p>
                </div>
                <div style="background:#f8fafc;padding:15px;border-radius:6px;margin-bottom:15px;position:relative;">
                    <button onclick="navigator.clipboard.writeText('[whmcs_promos type=&quot;hosting&quot; sort=&quot;discount_desc&quot; max_items=&quot;3&quot;]')" style="position:absolute;top:10px;right:10px;padding:5px 12px;background:#0891b2;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">üìã Copy</button>
                    <code style="display:block;font-size:14px;color:#1e293b;">[whmcs_promos type="hosting" sort="discount_desc" max_items="3"]</code>
                    <p style="margin:10px 0 0;font-size:13px;color:#64748b;">Show top 3 hosting deals</p>
                </div>

                <h3 style="color:#0891b2;margin-bottom:10px;">üìã All Available Parameters</h3>
                <table style="width:100%;border-collapse:collapse;margin-top:10px;">
                    <thead>
                        <tr style="background:#f1f5f9;">
                            <th style="text-align:left;padding:10px;border:1px solid #e2e8f0;">Parameter</th>
                            <th style="text-align:left;padding:10px;border:1px solid #e2e8f0;">Options</th>
                            <th style="text-align:left;padding:10px;border:1px solid #e2e8f0;">Default</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding:10px;border:1px solid #e2e8f0;"><code>type</code></td>
                            <td style="padding:10px;border:1px solid #e2e8f0;">all, domains, hosting, vps, ssl, email, dedicated, promo</td>
                            <td style="padding:10px;border:1px solid #e2e8f0;">all</td>
                        </tr>
                        <tr style="background:#f8fafc;">
                            <td style="padding:10px;border:1px solid #e2e8f0;"><code>sort</code></td>
                            <td style="padding:10px;border:1px solid #e2e8f0;">default, discount_desc, expiry_asc, display_order</td>
                            <td style="padding:10px;border:1px solid #e2e8f0;">default</td>
                        </tr>
                        <tr>
                            <td style="padding:10px;border:1px solid #e2e8f0;"><code>show_expired</code></td>
                            <td style="padding:10px;border:1px solid #e2e8f0;">yes, no</td>
                            <td style="padding:10px;border:1px solid #e2e8f0;">yes</td>
                        </tr>
                        <tr style="background:#f8fafc;">
                            <td style="padding:10px;border:1px solid #e2e8f0;"><code>max_items</code></td>
                            <td style="padding:10px;border:1px solid #e2e8f0;">Any number (e.g., 3, 6, 12)</td>
                            <td style="padding:10px;border:1px solid #e2e8f0;">50</td>
                        </tr>
                    </tbody>
                </table>

                <div style="background:#e7f3ff;padding:15px;border-radius:6px;margin-top:20px;border-left:4px solid #0891b2;">
                    <h4 style="margin:0 0 10px;color:#0891b2;">üí° Pro Tips</h4>
                    <ul style="margin:0;padding-left:20px;line-height:1.8;">
                        <li><strong>Mobile-First:</strong> All cards are fully responsive and optimized for mobile (70% of your users!)</li>
                        <li><strong>Black Friday:</strong> Codes with "bf", "blackfriday", "black", or "friday" get special gold styling automatically</li>
                        <li><strong>Price Override:</strong> Set discount type to "Override" in WHMCS to show exact pricing instead of percentages</li>
                        <li><strong>Custom Titles:</strong> Add JSON metadata to promo notes field for full control over titles and descriptions</li>
                        <li><strong>Products Metadata:</strong> Add <code>"products": "SSL, Reseller, Windows Hosting"</code> to generate titles like "Get 20% off our SSL, Reseller, Windows Hosting"</li>
                        <li><strong>Multi-Product Codes:</strong> Codes with multiple products automatically link to /start with promocode persistence</li>
                        <li><strong>Domain Search:</strong> Now opens in new tab like other buttons for better UX</li>
                        <li><strong>WP Code Lite:</strong> Use this plugin to add custom scripts in Header & Footer section instead of editing theme files</li>
                        <li><strong>Cache Issues:</strong> Using W3 Total Cache? Click "Clear Cache Now" to clear ALL caches (internal + W3TC)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    jQuery(document).ready(function($) {
        $('#whx-clear-cache-btn').on('click', function() {
            var btn = $(this);
            var msg = $('#whx-cache-message');
            var nonce = btn.data('nonce');
            
            btn.prop('disabled', true).text('‚è≥ Clearing...');
            msg.text('');
            
            $.ajax({
                url: ajaxurl,
                type: 'POST',
                data: {
                    action: 'whx_clear_promo_cache',
                    nonce: nonce
                },
                success: function(response) {
                    if (response.success) {
                        msg.text('‚úì ' + response.data.message).css('color', '#10b981');
                    } else {
                        msg.text('‚úó ' + response.data.message).css('color', '#ef4444');
                    }
                    btn.prop('disabled', false).text('üßπ Clear Cache Now');
                    setTimeout(function() { msg.fadeOut(); }, 3000);
                },
                error: function() {
                    msg.text('‚úó Error clearing cache').css('color', '#ef4444');
                    btn.prop('disabled', false).text('üßπ Clear Cache Now');
                }
            });
        });
    });
    </script>
    <?php
}

// ============================================================================
// SECTION 2: CORE UTILITY FUNCTIONS
// ============================================================================

/**
 * Parse JSON from Promo Notes Field
 */
function whx_parse_promo_notes($notes) {
    if (empty($notes)) return [];
    
    $notes = html_entity_decode($notes, ENT_QUOTES | ENT_HTML5, 'UTF-8');
    $notes = trim($notes);
    $notes = preg_replace('/^```(?:json)?\s*/i', '', $notes);
    $notes = preg_replace('/\s*```$/', '', $notes);
    $notes = trim($notes, '` ');
    
    $decoded = json_decode($notes, true);
    
    if (json_last_error() === JSON_ERROR_NONE && is_array($decoded)) {
        return $decoded;
    }
    
    return [];
}

/**
 * Get Market Base URL
 */
function whx_market_url() {
    if (function_exists('whx_market_cart_base')) {
        $cart_base = whx_market_cart_base();
        $parsed = parse_url($cart_base);
        if (isset($parsed['scheme'], $parsed['host'])) {
            return $parsed['scheme'] . '://' . $parsed['host'];
        }
    }
    return home_url();
}

/**
 * Build Smart URL with Promo Code
 */
function whx_build_smart_url($path, $code) {
    $market_url = whx_market_url();
    
    if (strpos($path, 'http://') === 0 || strpos($path, 'https://') === 0) {
        $base_url = $path;
    } elseif (strpos($path, '/') === 0) {
        $base_url = untrailingslashit($market_url) . $path;
    } else {
        $base_url = trailingslashit($market_url) . ltrim($path, '/');
    }
    
    if (strpos($base_url, '?') !== false) {
        $url = $base_url . '&promocode=' . rawurlencode($code);
    } else {
        $url = $base_url . '?promocode=' . rawurlencode($code);
    }
    
    if (filter_var($url, FILTER_VALIDATE_URL)) {
        return $url;
    }
    
    return add_query_arg('promocode', rawurlencode($code), $market_url);
}

/**
 * Get Category-Based Page Route
 */
function whx_get_category_page($categories, $tld_labels = []) {
    $settings = whx_promo_get_settings();
    $routes = $settings['routes'];
    
    if (!empty($categories['domains'])) {
        if (count($tld_labels) === 1) {
            $tld = strtolower(trim($tld_labels[0], '.'));
            
            // Special handling for .ke domains
            if ($tld === 'ke' || $tld === 'co.ke' || $tld === 'ac.ke') {
                return $routes['domains_ke'];
            }
            
            // Return general domains route (will be appended with ?domain= later)
            // DO NOT hardcode /cloud/cart.php here!
            return $routes['domains'];
        }
        
        if (isset($categories['transfer'])) return $routes['domains_transfer'];
        if (isset($categories['free'])) return $routes['domains_free'];
        
        return $routes['domains'];
    }
    
    if (!empty($categories['hosting'])) {
        if (isset($categories['cpanel'])) return $routes['hosting_cpanel'];
        if (isset($categories['cyberpanel'])) return $routes['hosting_cyberpanel'];
        if (isset($categories['windows'])) return $routes['hosting_windows'];
        if (isset($categories['reseller'])) return $routes['hosting_reseller'];
        if (isset($categories['free'])) return $routes['hosting_free'];
        if (isset($categories['dedicated'])) return $routes['hosting_dedicated'];
        return $routes['hosting'];
    }
    
    if (!empty($categories['vps'])) {
        if (isset($categories['managed'])) return $routes['vps_managed'];
        return $routes['vps'];
    }
    
    if (!empty($categories['email'])) return $routes['hosting_email'];
    if (!empty($categories['ssl'])) return $routes['ssl'];
    if (isset($categories['builder']) || isset($categories['ai'])) return $routes['ai_builder'];
    if (isset($categories['shop']) || isset($categories['ecommerce'])) return $routes['online_store'];
    if (isset($categories['seo'])) return $routes['seo'];
    
    return null;
}

/**
 * Categorize Product by Group Name
 * v9.9: Updated for actual product group names
 */
function whx_categorize_product_advanced($group, $metadata = []) {
    $group = strtolower($group);
    $categories = [];
    
    // ========================================================================
    // HOSTING CATEGORIES
    // ========================================================================
    $hosting_patterns = [
        'web hosting',
        'shared hosting',
        'cloud hosting',
        'managed cloud hosting',
        'free hosting',
        'free domain with ssd hosting',
        'ssd hosting'
    ];
    
    foreach ($hosting_patterns as $pattern) {
        if (strpos($group, $pattern) !== false) {
            $categories['hosting'] = true;
            
            // Sub-categories
            if (strpos($group, 'cpanel') !== false) $categories['cpanel'] = true;
            if (strpos($group, 'cyberpanel') !== false || strpos($group, 'litespeed') !== false) $categories['cyberpanel'] = true;
            if (strpos($group, 'free') !== false) $categories['free'] = true;
            
            break;
        }
    }
    
    // ========================================================================
    // WINDOWS HOSTING
    // ========================================================================
    if (strpos($group, 'windows hosting') !== false || strpos($group, 'asp.net') !== false) {
        $categories['hosting'] = true;
        $categories['windows'] = true;
    }
    
    // ========================================================================
    // RESELLER HOSTING
    // ========================================================================
    if (strpos($group, 'reseller hosting') !== false || strpos($group, 'reseller api') !== false) {
        $categories['hosting'] = true;
        $categories['reseller'] = true;
    }
    
    // ========================================================================
    // VPS CATEGORIES
    // ========================================================================
    $vps_patterns = [
        'vps hosting',
        'kenya vps',
        'vps',
        'virtual private',
        'cloud server',
        'linux cloud servers',
        'windows vps'
    ];
    
    foreach ($vps_patterns as $pattern) {
        if (strpos($group, $pattern) !== false) {
            $categories['vps'] = true;
            
            // Sub-categories
            if (strpos($group, 'managed') !== false || strpos($group, 'managed cloud') !== false) {
                $categories['managed'] = true;
            }
            if (strpos($group, 'windows') !== false) {
                $categories['windows'] = true;
            }
            if (strpos($group, 'kenya') !== false) {
                $categories['kenya'] = true;
            }
            
            break;
        }
    }
    
    // ========================================================================
    // DEDICATED SERVERS
    // ========================================================================
    if (strpos($group, 'dedicated') !== false || strpos($group, 'bare metal') !== false) {
        $categories['dedicated'] = true;
    }
    
    // ========================================================================
    // SSL CERTIFICATES
    // ========================================================================
    if (strpos($group, 'ssl') !== false || strpos($group, 'certificate') !== false) {
        $categories['ssl'] = true;
    }
    
    // ========================================================================
    // EMAIL & WORKSPACE
    // ========================================================================
    if (strpos($group, 'email') !== false || 
        strpos($group, 'workplace') !== false || 
        strpos($group, 'workspace') !== false ||
        strpos($group, 'workplace pro emails') !== false) {
        $categories['email'] = true;
    }
    
    // ========================================================================
    // DOMAINS
    // ========================================================================
    if (strpos($group, 'domain') !== false) {
        $categories['domains'] = true;
        
        if (strpos($group, 'transfer') !== false) $categories['transfer'] = true;
        if (strpos($group, 'free') !== false) $categories['free'] = true;
    }
    
    // ========================================================================
    // WEBSITES & BUILDERS
    // ========================================================================
    if (strpos($group, 'websites') !== false || 
        strpos($group, 'website builder') !== false || 
        strpos($group, 'ai') !== false) {
        $categories['builder'] = true;
        $categories['ai'] = true;
    }
    
    // ========================================================================
    // ONLINE SHOP / ECOMMERCE
    // ========================================================================
    if (strpos($group, 'online shop') !== false || 
        strpos($group, 'shop') !== false || 
        strpos($group, 'ecommerce') !== false) {
        $categories['shop'] = true;
        $categories['ecommerce'] = true;
    }
    
    // ========================================================================
    // SEO SERVICES
    // ========================================================================
    if (strpos($group, 'seo') !== false || strpos($group, 'local seo') !== false) {
        $categories['seo'] = true;
    }
    
    // ========================================================================
    // OTHER SERVICES
    // ========================================================================
    if (strpos($group, 'hire developer') !== false) {
        $categories['developer'] = true;
    }
    
    if (strpos($group, 'cloudoon vault') !== false) {
        $categories['vault'] = true;
    }
    
    // ========================================================================
    // METADATA OVERRIDE
    // ========================================================================
    if (!empty($metadata['category'])) {
        $categories[strtolower($metadata['category'])] = true;
    }
    
    // ========================================================================
    // FALLBACK
    // ========================================================================
    if (empty($categories)) {
        $categories['other'] = true;
    }
    
    return $categories;
}

/**
 * Generate Smart Promo Link
 * v9.8: Intelligent URL Builder for WordPress + WHMCS Hybrid Setup
 * 
 * Priority Order:
 * 1. Manual link override from JSON metadata
 * 2. Intelligent URL building based on destination type:
 *    - WHMCS Cart: Full parameter support (query, pid, etc.)
 *    - WHMCS Store: Simple promocode append
 *    - WordPress Pages: Promocode append (requires JS bridge for persistence)
 * 3. WHMCS cart fallbacks
 */
function whx_generate_promo_link($code, $metadata, $categories, $has_domains, $domain_only, $tld_labels = [], $product_ids = []) {
    $settings = whx_promo_get_settings();
    $routes = $settings['routes'];
    $market_url = whx_market_url();
    $cart_base = function_exists('whx_market_cart_base') ? whx_market_cart_base() : $market_url . $routes['whmcs_cart'];
    
    // Convert TLD labels to clean keys
    $tld_keys = [];
    foreach ($tld_labels as $label) {
        $tld_keys[] = ltrim(strtolower($label), '.');
    }
    
    whx_promo_debug("üîó Generating promo link for: $code", [
        'has_domains' => $has_domains,
        'domain_only' => $domain_only,
        'tld_labels' => $tld_labels,
        'tld_keys' => $tld_keys,
        'product_count' => count($product_ids),
        'categories' => array_keys($categories),
        'manual_link' => !empty($metadata['link']) ? $metadata['link'] : 'none'
    ]);
    
    // ========================================================================
    // PRIORITY 1: Manual link override from JSON metadata (HIGHEST PRIORITY)
    // ========================================================================
    if (!empty($metadata['link'])) {
        $url = whx_build_smart_url($metadata['link'], $code);
        whx_promo_debug("‚úì Using manual link override", ['url' => $url]);
        return $url;
    }
    
    // ========================================================================
    // PRIORITY 2: Category-based routing (INTELLIGENT URL BUILDER)
    // ========================================================================
    $category_page = whx_get_category_page($categories, $tld_keys);
    
    if ($category_page) {
        whx_promo_debug("üìç Category page detected", [
            'page' => $category_page,
            'has_domains' => $has_domains,
            'tld_count' => count($tld_keys)
        ]);
        
        // Detect destination type
        $is_whmcs_cart = (strpos($category_page, 'cart.php') !== false || 
                         strpos($category_page, 'a=add') !== false ||
                         strpos($category_page, 'domain=register') !== false);
        
        $is_whmcs_store = (strpos($category_page, '/cloud/store') !== false ||
                          strpos($category_page, '/store') !== false);
        
        $is_wordpress_page = !$is_whmcs_cart && !$is_whmcs_store;
        
        // ====================================================================
        // TYPE A: WHMCS CART - Full parameter support
        // ====================================================================
        if ($is_whmcs_cart) {
            whx_promo_debug("üõí WHMCS Cart URL detected");
            
            // Parse existing URL
            $parsed = parse_url($category_page);
            $base_path = $parsed['path'] ?? '/cloud/cart.php';
            $existing_params = [];
            
            if (isset($parsed['query'])) {
                parse_str($parsed['query'], $existing_params);
            }
            
            // Build complete parameter array
            $params = $existing_params; // Keep existing params like a=add&domain=register
            $params['promocode'] = $code;
            
            // Add domain-specific parameters
            if ($has_domains && !empty($tld_keys) && count($tld_keys) === 1) {
                // Single TLD - add as query parameter
                if (isset($params['domain']) && $params['domain'] === 'register') {
                    $params['query'] = '.' . $tld_keys[0];
                }
            }
            
            // Add product ID if single product (non-domain)
            if (!$has_domains && !empty($product_ids) && count($product_ids) === 1) {
                $params['a'] = 'add';
                $params['pid'] = $product_ids[0];
            }
            
            // Build final URL
            $url = $market_url . $base_path . '?' . http_build_query($params);
            
            whx_promo_debug("‚úì Built WHMCS cart URL", [
                'type' => 'whmcs_cart',
                'base_path' => $base_path,
                'params' => $params,
                'url' => $url
            ]);
            
            return $url;
        }
        
        // ====================================================================
        // TYPE B: WHMCS STORE - Simple promocode append
        // ====================================================================
        elseif ($is_whmcs_store) {
            whx_promo_debug("üè™ WHMCS Store URL detected");
            
            // For WHMCS store, just append promocode
            $separator = (strpos($category_page, '?') !== false) ? '&' : '?';
            $url = $market_url . $category_page . $separator . 'promocode=' . rawurlencode($code);
            
            whx_promo_debug("‚úì Built WHMCS store URL", [
                'type' => 'whmcs_store',
                'url' => $url
            ]);
            
            return $url;
        }
        
        // ====================================================================
        // TYPE C: WORDPRESS PAGE - Promocode append (JS bridge needed)
        // ====================================================================
        else {
            whx_promo_debug("üìÑ WordPress page detected");
            
            // WordPress pages: append promocode to URL
            // Note: WordPress doesn't handle promocodes natively
            // Requires JavaScript bridge for WHMCS persistence
            $separator = (strpos($category_page, '?') !== false) ? '&' : '?';
            $url = $market_url . $category_page . $separator . 'promocode=' . rawurlencode($code);
            
            whx_promo_debug("‚úì Built WordPress URL", [
                'type' => 'wordpress_page',
                'url' => $url,
                'note' => 'Requires JS bridge for WHMCS persistence'
            ]);
            
            return $url;
        }
    }
    
    whx_promo_debug("‚ö†Ô∏è No category page found, using fallbacks");

    // ========================================================================
    // PRIORITY 3: Multi-Product Default to /start (v9.9.2)
    // ========================================================================
    if (count($product_ids) > 1) {
        // Multiple products ‚Üí default to /start with promocode
        $url = $market_url . '/start?promocode=' . rawurlencode($code);
        whx_promo_debug("‚Üí Multi-product: Defaulting to /start", [
            'product_count' => count($product_ids),
            'url' => $url
        ]);
        return $url;
    }

    // ========================================================================
    // PRIORITY 4: WHMCS Cart Fallbacks (ONLY if no category match)
    // ========================================================================

    // Fallback 4a: Single product direct cart add
    if (!$domain_only && count($product_ids) === 1) {
        $pid = $product_ids[0];
        $url = $cart_base . '?a=add&pid=' . $pid . '&promocode=' . rawurlencode($code);
        whx_promo_debug("‚Üí Fallback: Single product cart URL", ['pid' => $pid, 'url' => $url]);
        return $url;
    }
    
    // Fallback 3c: Domain-only WHMCS cart (last resort for domains)
    if ($domain_only && !empty($tld_keys)) {
        if (count($tld_keys) === 1) {
            $url = $market_url . '/cloud/cart.php?a=add&domain=register&query=.' . $tld_keys[0] . '&promocode=' . rawurlencode($code);
            whx_promo_debug("‚Üí Fallback: Single TLD WHMCS cart", ['tld' => $tld_keys[0], 'url' => $url]);
            return $url;
        }
        
        // Multiple TLDs - use general domain registration page
        $separator = (strpos($routes['domains'], '?') !== false) ? '&' : '?';
        $url = $market_url . $routes['domains'] . $separator . 'promocode=' . rawurlencode($code);
        whx_promo_debug("‚Üí Fallback: Multiple TLDs domain page", ['url' => $url]);
        return $url;
    }
    
    // ========================================================================
    // PRIORITY 4: Global fallback (should rarely be used)
    // ========================================================================
    $url = $market_url . $routes['whmcs_store'] . '?promocode=' . rawurlencode($code);
    whx_promo_debug("‚ö†Ô∏è GLOBAL FALLBACK: Using store page", ['url' => $url]);
    return $url;
}

// ============================================================================
// SECTION 3: WHMCS API DATA FETCHING
// ============================================================================

/**
 * Get Promotions from WHMCS
 */
function whx_get_promos_v5() {
    if (!function_exists('whx_request')) return [];
    
    $settings = whx_promo_get_settings();
    $key = 'whx_promos_v5';
    
    // Check cache (works with W3 Total Cache, WP Rocket, etc.)
    if ($settings['cache']['enable_cache']) {
        $cached = get_transient($key);
        // get_transient returns FALSE on cache miss, or the actual value
        // Even empty arrays [] are valid cached data!
        if ($cached !== false) {
            whx_promo_debug('Cache HIT: Promos', ['count' => count($cached)]);
            return $cached;
        }
    }

    whx_promo_debug('Cache MISS: Fetching promos from WHMCS');

    try {
        $data = whx_request('GetPromotions', []);
        
        if (empty($data['promotions']['promotion'])) {
            // Store empty result in cache to prevent repeated API calls
            if ($settings['cache']['enable_cache']) {
                set_transient($key, [], 5 * MINUTE_IN_SECONDS);
            }
            return [];
        }

        $promos = $data['promotions']['promotion'];
        if (isset($promos['id'])) $promos = [$promos];

        $promos = array_filter($promos, function($p) {
            return !empty($p['code']);
        });

        // Store in cache
        if ($settings['cache']['enable_cache']) {
            set_transient($key, $promos, $settings['cache']['promos_ttl'] * MINUTE_IN_SECONDS);
            whx_promo_debug('Cache STORED: Promos', [
                'count' => count($promos),
                'ttl' => $settings['cache']['promos_ttl'] . ' minutes'
            ]);
        }
        
        return $promos;
        
    } catch (Exception $e) {
        whx_promo_debug('ERROR fetching promos', ['error' => $e->getMessage()]);
        return [];
    }
}

/**
 * Get Products from WHMCS
 */
function whx_get_products_v5() {
    if (!function_exists('whx_request')) return [];
    
    $settings = whx_promo_get_settings();
    $key = 'whx_products_v5_batch';
    
    // Check cache (works with W3 Total Cache, WP Rocket, etc.)
    if ($settings['cache']['enable_cache']) {
        $cached = get_transient($key);
        if ($cached !== false) {
            whx_promo_debug('Cache HIT: Products', ['count' => count($cached)]);
            return $cached;
        }
    }

    whx_promo_debug('Cache MISS: Fetching products from WHMCS');

    try {
        $data = whx_request('GetProducts', []);
        $out = [];

        if (!empty($data['products']['product'])) {
            $list = $data['products']['product'];
            if (isset($list['pid'])) $list = [$list];
            
            foreach ($list as $item) {
                $pid = isset($item['pid']) ? sanitize_text_field($item['pid']) : '';
                if (empty($pid) || !ctype_digit($pid)) continue;
                
                $out[$pid] = [
                    'name' => isset($item['name']) ? sanitize_text_field($item['name']) : '',
                    'group' => isset($item['groupname']) ? strtolower(sanitize_text_field($item['groupname'])) : '',
                    'raw' => $item,
                ];
            }
        }

        // Store in cache
        if ($settings['cache']['enable_cache']) {
            set_transient($key, $out, $settings['cache']['products_ttl'] * MINUTE_IN_SECONDS);
            whx_promo_debug('Cache STORED: Products', [
                'count' => count($out),
                'ttl' => $settings['cache']['products_ttl'] . ' minutes'
            ]);
        }
        
        return $out;
        
    } catch (Exception $e) {
        whx_promo_debug('ERROR fetching products', ['error' => $e->getMessage()]);
        return [];
    }
}

/**
 * Get TLD Pricing from WHMCS
 */
function whx_get_tlds_v5() {
    if (!function_exists('whx_request')) return [];
    
    $settings = whx_promo_get_settings();
    $key = 'whx_tlds_v5_gettldpricing';
    
    // Check cache (works with W3 Total Cache, WP Rocket, etc.)
    if ($settings['cache']['enable_cache']) {
        $cached = get_transient($key);
        if ($cached !== false) {
            whx_promo_debug('Cache HIT: TLDs', ['count' => count($cached)]);
            return $cached;
        }
    }

    whx_promo_debug('Cache MISS: Fetching TLDs from WHMCS');

    try {
        $currency_id = function_exists('whx_market_currency_id') ? whx_market_currency_id() : 1;
        
        $data = whx_request('GetTLDPricing', [
            'currencyid' => $currency_id
        ]);
        
        if (empty($data['pricing'])) {
            whx_promo_debug('WARNING: No TLD pricing data returned from WHMCS');
            return [];
        }
        
        $out = [];
        
        foreach ($data['pricing'] as $tld => $tld_data) {
            $tld_clean = ltrim(strtolower($tld), '.');
            
            if (!empty($tld_clean)) {
                // Extract pricing more robustly
                $register_price = [];
                
                if (isset($tld_data['register'])) {
                    $register_price = $tld_data['register'];
                } elseif (isset($tld_data['registration'])) {
                    $register_price = $tld_data['registration'];
                }
                
                // Store TLD data
                $out[$tld_clean] = [
                    'label' => '.' . strtoupper($tld_clean),
                    'price' => $register_price,
                    'raw' => $tld_data // Store full data for debugging
                ];
                
                whx_promo_debug("TLD detected: $tld_clean", [
                    'has_pricing' => !empty($register_price),
                    'price_keys' => array_keys($register_price)
                ]);
            }
        }

        whx_promo_debug('TLDs processed', [
            'total_count' => count($out),
            'sample_tlds' => array_slice(array_keys($out), 0, 5)
        ]);

        // Store in cache
        if ($settings['cache']['enable_cache']) {
            set_transient($key, $out, $settings['cache']['tlds_ttl'] * MINUTE_IN_SECONDS);
            whx_promo_debug('Cache STORED: TLDs', [
                'count' => count($out),
                'ttl' => $settings['cache']['tlds_ttl'] . ' minutes'
            ]);
        }
        
        return $out;
        
    } catch (Exception $e) {
        whx_promo_debug('ERROR fetching TLDs', ['error' => $e->getMessage()]);
        return [];
    }
}

// ============================================================================
// SECTION 4: PRICING CALCULATION FUNCTIONS
// ============================================================================

/**
 * Extract Product Pricing for Specific Cycle
 */
function whx_extract_product_pricing($product_data, $preferred_cycle = 'annually') {
    if (empty($product_data) || !isset($product_data['raw'])) return null;
    
    $item = $product_data['raw'];
    $pricing = [];
    
    $currency = function_exists('whx_market_currency') ? whx_market_currency() : 'USD';
    
    if (isset($item['pricing'][$currency]) && is_array($item['pricing'][$currency])) {
        $currency_pricing = $item['pricing'][$currency];
        
        $cycles = ['monthly', 'quarterly', 'semiannually', 'annually', 'biennially', 'triennially'];
        
        foreach ($cycles as $cycle) {
            if (isset($currency_pricing[$cycle])) {
                $price = floatval($currency_pricing[$cycle]);
                if ($price > 0) {
                    $pricing[$cycle] = $price;
                }
            }
        }
    }
    
    if (empty($pricing)) {
        $cycles = ['monthly', 'quarterly', 'semiannually', 'annually', 'biennially', 'triennially'];
        foreach ($cycles as $cycle) {
            if (isset($item[$cycle]) && is_numeric($item[$cycle])) {
                $price = floatval($item[$cycle]);
                if ($price > 0) {
                    $pricing[$cycle] = $price;
                }
            }
        }
    }
    
    if (empty($pricing)) return null;
    
    $cycle_priority = [
        'annually' => ['annually', 'semiannually', 'quarterly', 'monthly'],
        'semiannually' => ['semiannually', 'annually', 'quarterly', 'monthly'],
        'quarterly' => ['quarterly', 'semiannually', 'annually', 'monthly'],
        'monthly' => ['monthly', 'quarterly', 'semiannually', 'annually'],
    ];
    
    $search_order = isset($cycle_priority[$preferred_cycle]) ? $cycle_priority[$preferred_cycle] : $cycle_priority['annually'];
    
    foreach ($search_order as $cycle) {
        if (isset($pricing[$cycle]) && $pricing[$cycle] > 0) {
            return [
                'price' => $pricing[$cycle],
                'cycle' => $cycle,
            ];
        }
    }
    
    return null;
}

/**
 * Calculate Domain Pricing with Discount
 */
function whx_calculate_domain_pricing($tld_labels, $tlds_data, $promo_type, $promo_value) {
    if (empty($tld_labels) || empty($tlds_data)) {
        whx_promo_debug('Domain pricing: No TLDs or data', [
            'tld_labels' => count($tld_labels),
            'tlds_data' => count($tlds_data)
        ]);
        return null;
    }
    
    $currency_symbol = function_exists('whx_market_currency') ? whx_market_currency() : 'USD';
    
    foreach ($tld_labels as $tld) {
        $tld_clean = ltrim(strtolower($tld), '.');
        
        if (!isset($tlds_data[$tld_clean])) {
            whx_promo_debug("TLD not in pricing data: $tld_clean");
            continue;
        }
        
        if (empty($tlds_data[$tld_clean]['price'])) {
            whx_promo_debug("TLD has no pricing: $tld_clean", [
                'tld_data' => $tlds_data[$tld_clean]
            ]);
            continue;
        }
        
        $pricing_data = $tlds_data[$tld_clean]['price'];
        
        whx_promo_debug("Processing TLD pricing: $tld_clean", [
            'pricing_keys' => array_keys($pricing_data),
            'pricing_values' => $pricing_data
        ]);
        
        // Try multiple methods to extract price
        $original_price = 0;
        
        // Method 1: Check for '1' key (1 year registration)
        if (isset($pricing_data['1']) && is_numeric($pricing_data['1'])) {
            $original_price = floatval($pricing_data['1']);
            whx_promo_debug("Found price using key '1'", ['price' => $original_price]);
        }
        // Method 2: Check for 'register' key
        elseif (isset($pricing_data['register']) && is_numeric($pricing_data['register'])) {
            $original_price = floatval($pricing_data['register']);
            whx_promo_debug("Found price using key 'register'", ['price' => $original_price]);
        }
        // Method 3: Check first numeric value in array
        elseif (is_array($pricing_data) && !empty($pricing_data)) {
            foreach ($pricing_data as $key => $value) {
                if (is_numeric($value) && floatval($value) > 0) {
                    $original_price = floatval($value);
                    whx_promo_debug("Found price using first numeric value", [
                        'key' => $key,
                        'price' => $original_price
                    ]);
                    break;
                }
            }
        }
        // Method 4: If pricing_data is numeric itself
        elseif (is_numeric($pricing_data)) {
            $original_price = floatval($pricing_data);
            whx_promo_debug("Price is direct numeric value", ['price' => $original_price]);
        }
        
        if ($original_price <= 0) {
            whx_promo_debug("No valid price found for TLD: $tld_clean", [
                'pricing_data_type' => gettype($pricing_data),
                'pricing_data' => $pricing_data
            ]);
            continue;
        }
        
        // Calculate discounted price
        $discounted_price = $original_price;
        
        if ($promo_type === 'percentage' && $promo_value > 0) {
            $discounted_price = $original_price * (1 - ($promo_value / 100));
        } elseif ($promo_type === 'fixed amount' && $promo_value > 0) {
            $discounted_price = max(0, $original_price - $promo_value);
        }
        
        // Only show pricing if there's actually a discount
        if ($discounted_price >= $original_price) {
            whx_promo_debug("No discount applied for TLD: $tld_clean", [
                'original' => $original_price,
                'discounted' => $discounted_price
            ]);
            continue;
        }
        
        // Format prices
        if (function_exists('whx_money')) {
            $price_now = whx_money($discounted_price, $currency_symbol);
            $price_was = whx_money($original_price, $currency_symbol);
        } else {
            $price_now = '$' . number_format($discounted_price, 2);
            $price_was = '$' . number_format($original_price, 2);
        }
        
        whx_promo_debug("Domain pricing calculated for: $tld_clean", [
            'original' => $price_was,
            'discounted' => $price_now
        ]);
        
        return [
            'price_now' => $price_now,
            'price_was' => $price_was,
            'price_period' => 'yr',
        ];
    }
    
    whx_promo_debug('No valid domain pricing found for any TLD');
    return null;
}

/**
 * Calculate Product Pricing with Discount
 */
function whx_calculate_promo_pricing($product_ids, $products, $promo_type, $promo_value, $preferred_cycle = 'annually') {
    if (empty($product_ids) || empty($products)) return null;
    
    $currency_symbol = function_exists('whx_market_currency') ? whx_market_currency() : 'USD';
    
    foreach ($product_ids as $pid) {
        if (!isset($products[$pid])) continue;
        
        $pricing_info = whx_extract_product_pricing($products[$pid], $preferred_cycle);
        
        if (!$pricing_info) continue;
        
        $original_price = $pricing_info['price'];
        $cycle = $pricing_info['cycle'];
        $discounted_price = $original_price;
        
        if ($promo_type === 'percentage' && $promo_value > 0) {
            $discounted_price = $original_price * (1 - ($promo_value / 100));
        } elseif ($promo_type === 'fixed amount' && $promo_value > 0) {
            $discounted_price = max(0, $original_price - $promo_value);
        }
        
        if ($discounted_price >= $original_price) continue;
        
        if (function_exists('whx_money')) {
            $price_now = whx_money($discounted_price, $currency_symbol);
            $price_was = whx_money($original_price, $currency_symbol);
        } else {
            $price_now = '$' . number_format($discounted_price, 2);
            $price_was = '$' . number_format($original_price, 2);
        }
        
        $period_map = [
            'monthly' => 'mo',
            'quarterly' => 'qtr',
            'semiannually' => '6mo',
            'annually' => 'yr',
            'biennially' => '2yr',
            'triennially' => '3yr',
        ];
        $period = isset($period_map[$cycle]) ? $period_map[$cycle] : 'yr';
        
        return [
            'price_now' => $price_now,
            'price_was' => $price_was,
            'price_period' => $period,
        ];
    }
    
    return null;
}

/**
 * Generate Promo Card Title
 * v9.9.2: Added products metadata support for multi-product custom titles
 */
function whx_generate_promo_title($has_domains, $categories, $tld_labels, $discount_text, $domain_only = false, $custom_title = '', $promo_type = '', $products_meta = '') {
    // Priority 1: Custom title from metadata
    if (!empty($custom_title)) {
        whx_promo_debug("Using custom title", ['title' => $custom_title]);
        return $custom_title;
    }

    $subject = '';

    // Priority 2: Products metadata (e.g., "SSL, Reseller, Windows Hosting")
    if (!empty($products_meta)) {
        $subject = $products_meta;
        whx_promo_debug("Using products metadata", ['products' => $products_meta]);
    }
    // Priority 3: Domain titles (check FIRST!)
    elseif ($has_domains && !empty($tld_labels)) {
        if (count($tld_labels) === 1) {
            // Single TLD - use specific title like ".COM Domain"
            $subject = $tld_labels[0] . ' Domain';
            whx_promo_debug("Generated single TLD title", [
                'tld' => $tld_labels[0],
                'subject' => $subject
            ]);
        } elseif (count($tld_labels) > 1) {
            // Multiple TLDs
            $subject = 'Domain Registration';
            whx_promo_debug("Generated multiple TLD title", [
                'tld_count' => count($tld_labels),
                'subject' => $subject
            ]);
        }
    }
    // Priority 4: Product category titles (if no domain title or products meta was set)
    else {
        if (!empty($categories['hosting'])) {
            $subject = 'Hosting Plans';
        } elseif (!empty($categories['vps'])) {
            $subject = 'VPS Servers';
        } elseif (!empty($categories['ssl'])) {
            $subject = 'SSL Certificates';
        } elseif (!empty($categories['email'])) {
            $subject = 'Email & Workspace';
        } elseif (!empty($categories['dedicated'])) {
            $subject = 'Dedicated Servers';
        } else {
            $subject = 'Selected Products';
        }

        whx_promo_debug("Generated category title", [
            'categories' => array_keys($categories),
            'subject' => $subject
        ]);
    }

    // Generate title based on promo type
    if ($promo_type === 'override' || $promo_type === 'price override') {
        // For price override: "Get .COM Domain at [Price]" or "Get Hosting Plans from [Price]"
        if (strpos($discount_text, 'Ksh') !== false || strpos($discount_text, 'USD') !== false ||
            strpos($discount_text, '$') !== false || strpos($discount_text, '‚Ç¨') !== false) {
            return sprintf('Get %s from %s', $subject, $discount_text);
        } else {
            return sprintf('Get %s ‚Äî %s', $subject, $discount_text);
        }
    } elseif (strpos($discount_text, 'Save') !== false) {
        // For fixed amount: "Get SSL, Reseller and Windows Hosting Plans ‚Äî Save Ksh 200"
        return sprintf('Get %s ‚Äî %s', $subject, $discount_text);
    } else {
        // For percentage: "Get 20% off our SSL, Reseller and Windows Hosting Plans"
        if (!empty($products_meta)) {
            return sprintf('Get %s off our %s', $discount_text, $subject);
        } else {
            return sprintf('Get %s for %s', $subject, $discount_text);
        }
    }
}

// ============================================================================
// SECTION 5: MAIN SHORTCODE & CARD RENDERING
// ============================================================================

/**
 * Register Shortcode
 */
add_shortcode('whmcs_promos', 'whx_whmcs_promos_shortcode_v9');

/**
 * Main Shortcode Function - Renders Promo Cards
 */
function whx_whmcs_promos_shortcode_v9($atts) {
    // Check Dependencies
    if (!function_exists('whx_market_cart_base') || !function_exists('whx_request')) {
        return '<div class="whx-notice whx-notice--error"><p>WHX Core plugin not active.</p></div>';
    }

    // Parse Shortcode Attributes
    $defaults = [
        'type' => 'all',
        'tlds' => '',
        'sort' => 'default',
        'show_expired' => 'yes',
        'max_items' => '50',
        'category' => '',
        'tag' => '',
        'featured_only' => 'no',
        'display_only' => 'yes',
    ];
    
    $atts = shortcode_atts($defaults, $atts);
    $settings = whx_promo_get_settings();
    
    // Fetch Data from WHMCS
    $promos = whx_get_promos_v5();
    $products = whx_get_products_v5();
    $tlds_map = whx_get_tlds_v5();
    $now = current_time('timestamp');
    $market_url = whx_market_url();

    whx_promo_debug('Shortcode started', [
        'promos_count' => count($promos),
        'products_count' => count($products),
        'tlds_count' => count($tlds_map),
    ]);

    if (empty($promos)) {
        return '<div class="whx-notice whx-notice--info"><p>No promotions available.</p></div>';
    }

    $items = [];

    // Process Each Promo
    foreach ($promos as $promo) {
        if (count($items) >= absint($atts['max_items'])) break;
        
        $code = isset($promo['code']) ? sanitize_text_field($promo['code']) : '';
        if (empty($code)) continue;
        
        $type = isset($promo['type']) ? strtolower(sanitize_text_field($promo['type'])) : '';
        $value = isset($promo['value']) ? sanitize_text_field($promo['value']) : '';
        $expiry = isset($promo['expirationdate']) ? sanitize_text_field($promo['expirationdate']) : '';
        $applies_raw = isset($promo['appliesto']) ? sanitize_text_field($promo['appliesto']) : '';
        $notes = isset($promo['notes']) ? $promo['notes'] : '';
        $created = isset($promo['created']) ? sanitize_text_field($promo['created']) : '';
        $created_ts = $created ? strtotime($created) : 0;
        
        whx_promo_debug("Processing promo: $code", [
            'applies_to_raw' => $applies_raw,
            'type' => $type,
            'value' => $value,
        ]);
        
        $metadata = whx_parse_promo_notes($notes);
        
        // Apply Filters
        if ($atts['display_only'] === 'yes' && empty($metadata['display'])) continue;
        if ($atts['featured_only'] === 'yes' && empty($metadata['featured'])) continue;
        if (!empty($atts['category']) && (!isset($metadata['category']) || $metadata['category'] !== $atts['category'])) continue;
        
        $ts = ($expiry && $expiry !== '0000-00-00') ? strtotime($expiry) : 0;
        $is_expired = $ts && $ts < $now;
        if ($is_expired && $atts['show_expired'] === 'no') continue;

        // ====================================================================
        // v9.6.0 FIX: Cross-Reference TLDs with WHMCS GetTLDPricing
        // ====================================================================
        $tokens = $applies_raw ? array_filter(array_map('trim', explode(',', $applies_raw))) : [];
        $categories = [];
        $promo_tlds = [];
        $product_ids = [];

        foreach ($tokens as $token) {
            $token = sanitize_text_field($token);
            
            if (ctype_digit($token)) {
                // It's a Product ID
                $product_ids[] = $token;
                
                if (isset($products[$token])) {
                    $group = $products[$token]['group'];
                    $product_categories = whx_categorize_product_advanced($group, $metadata);
                    $categories = array_merge($categories, $product_categories);
                }
            } else {
                // It's potentially a TLD - extract ONLY the TLD part!
                // Examples: "com" ‚Üí "com", ".com" ‚Üí "com", "d.com" ‚Üí "com", "moneyspace.d.com" ‚Üí "com"
                
                $tok = ltrim($token, '.');  // Remove leading dot
                
                // If token contains dots (like "d.com" or "moneyspace.d.com"), get the LAST part
                if (strpos($tok, '.') !== false) {
                    $parts = explode('.', $tok);
                    $tok = end($parts); // Get last part = actual TLD
                    
                    whx_promo_debug("Extracted TLD from dotted token for $code", [
                        'original_token' => $token,
                        'extracted_tld' => $tok
                    ]);
                }
                
                $tok_lower = strtolower(trim($tok));
                
                // ‚úÖ v9.9 FIX: Validate ACTUAL TLD (not compound strings!)
                // Valid TLD: 2+ chars, alphabetic, NO DOTS
                if (strlen($tok_lower) >= 2 && ctype_alpha($tok_lower) && strpos($tok_lower, '.') === false) {
                    // Check if in WHMCS pricing for label
                    if (isset($tlds_map[$tok_lower])) {
                        $label = $tlds_map[$tok_lower]['label'];
                        whx_promo_debug("‚úì Valid TLD with WHMCS pricing for $code", [
                            'token' => $token,
                            'tld_clean' => $tok_lower,
                            'label' => $label,
                            'has_pricing' => true
                        ]);
                    } else {
                        // Valid format but no WHMCS pricing - still accept it!
                        $label = '.' . strtoupper($tok_lower);
                        whx_promo_debug("‚úì Valid TLD without WHMCS pricing for $code", [
                            'token' => $token,
                            'tld_clean' => $tok_lower,
                            'label' => $label,
                            'has_pricing' => false,
                            'note' => 'Will still show form and create link'
                        ]);
                    }
                    
                    // Add to promo_tlds array
                    $promo_tlds[$tok_lower] = $label;
                    $categories['domains'] = true;
                    
                } else {
                    // Invalid TLD format
                    whx_promo_debug("‚ö†Ô∏è Rejected invalid TLD token for $code", [
                        'token' => $token,
                        'tld_extracted' => $tok_lower,
                        'length' => strlen($tok_lower),
                        'is_alpha' => ctype_alpha($tok_lower),
                        'has_dots' => strpos($tok_lower, '.') !== false,
                        'reason' => 'Invalid TLD format (too short, non-alphabetic, or contains dots)'
                    ]);
                }
            }
        }

        $has_domains = !empty($categories['domains']);
        $non_domain_cats = array_diff_key($categories, ['domains' => true]);
        $domain_only = $has_domains && empty($non_domain_cats);
        
        // ‚úÖ v9.8 FIX: Show domain search if TLDs exist (regardless of WHMCS pricing!)
        $show_domain_search = !empty($promo_tlds) && count($promo_tlds) > 0;

        whx_promo_debug("Promo $code detection summary", [
            'has_domains' => $has_domains,
            'domain_only' => $domain_only,
            'show_domain_search' => $show_domain_search,
            'tld_count' => count($promo_tlds),
            'tlds' => array_keys($promo_tlds),
            'product_count' => count($product_ids),
            'categories' => array_keys($categories),
        ]);

        // Type Filter
        if ($atts['type'] !== 'all') {
            if ($atts['type'] === 'domains' && !$has_domains) continue;
            elseif (empty($categories[$atts['type']])) continue;
        }

        // Calculate Discount Text
        $discount_value = is_numeric($value) ? floatval($value) : 0;
        $is_black_friday = (stripos($code, 'bf') !== false || stripos($code, 'blackfriday') !== false ||
                           stripos($code, 'black') !== false || stripos($code, 'friday') !== false);

        if ($type === 'percentage' && $discount_value > 0) {
            $discount_text = number_format($discount_value, 0) . '% Off';
        } elseif ($type === 'fixed amount' && $discount_value > 0 && function_exists('whx_money')) {
            // Fixed: Remove "for" - correct is "Save Ksh 200" not "Save for Ksh 200"
            $discount_text = 'Save ' . whx_money($discount_value, whx_market_currency());
        } elseif ($type === 'override' || $type === 'price override') {
            // Price Override: Show the actual override price instead of "Special Offer"
            if ($discount_value > 0 && function_exists('whx_money')) {
                $discount_text = whx_money($discount_value, whx_market_currency());
            } else {
                $discount_text = 'Special Pricing';
            }
        } else {
            $discount_text = 'Special Offer';
        }

        // Add Black Friday badge to discount text
        if ($is_black_friday) {
            $discount_text = 'üî• ' . $discount_text;
        }

        // Get TLD Data
        $promo_tld_labels = array_values($promo_tlds); // Display labels like ".COM"
        $promo_tld_keys = array_keys($promo_tlds); // Clean TLDs like "com"
        
        // Sort TLDs by length (prefer longer TLDs like "com" over short garbage)
        if (!empty($promo_tld_keys)) {
            usort($promo_tld_keys, function($a, $b) {
                return strlen($b) - strlen($a); // Longer TLDs first
            });
            
            // Rebuild labels array to match sorted keys
            $sorted_labels = [];
            foreach ($promo_tld_keys as $key) {
                $sorted_labels[] = $promo_tlds[$key];
            }
            $promo_tld_labels = $sorted_labels;
        }
        
        // Generate Title (v9.9.2: Now with products metadata support!)
        $custom_title = isset($metadata['title']) ? sanitize_text_field($metadata['title']) : '';
        $products_meta = isset($metadata['products']) ? sanitize_text_field($metadata['products']) : '';
        $display_title = whx_generate_promo_title($has_domains, $categories, $promo_tld_labels, $discount_text, $domain_only, $custom_title, $type, $products_meta);

        // Get Description
        $custom_desc = isset($metadata['description']) ? wp_kses_post($metadata['description']) : '';
        $whmcs_desc = isset($promo['description']) ? wp_kses_post(trim($promo['description'])) : '';
        $final_desc = !empty($custom_desc) ? $custom_desc : $whmcs_desc;

        // Determine Category Label
        if (!empty($metadata['category'])) {
            $cat_label = sanitize_text_field($metadata['category']);
        } elseif ($domain_only) {
            $cat_label = 'Domains';
        } elseif (!empty($categories['hosting'])) {
            $cat_label = 'Hosting';
        } elseif (!empty($categories['vps'])) {
            $cat_label = 'VPS';
        } elseif (!empty($categories['ssl'])) {
            $cat_label = 'SSL';
        } elseif (!empty($categories['email'])) {
            $cat_label = 'Email';
        } elseif (!empty($categories['dedicated'])) {
            $cat_label = 'Dedicated';
        } else {
            $cat_label = 'Promo';
        }

        // Calculate Badge States
        $is_hot = ($type === 'percentage' && $discount_value >= $settings['badges']['hot_threshold']);
        $ending_soon = (!$is_expired && $ts && $ts <= ($now + $settings['badges']['ending_soon_days'] * DAY_IN_SECONDS));

        // Generate Link
        $link = whx_generate_promo_link($code, $metadata, $categories, $has_domains, $domain_only, $promo_tld_labels, $product_ids);

        // Calculate Pricing
        $pricing_data = null;
        
        if (!empty($metadata['price_now'])) {
            $pricing_data = [
                'price_now' => $metadata['price_now'],
                'price_was' => isset($metadata['price_was']) ? $metadata['price_was'] : '',
                'price_period' => isset($metadata['price_period']) ? $metadata['price_period'] : 'yr',
            ];
        } else {
            if ($settings['pricing']['show_domain_pricing'] && $domain_only && !empty($promo_tld_labels)) {
                $pricing_data = whx_calculate_domain_pricing(
                    $promo_tld_labels,
                    $tlds_map,
                    $type,
                    $discount_value
                );
            } elseif ($settings['pricing']['auto_detect'] && !$domain_only && !empty($product_ids)) {
                $pricing_data = whx_calculate_promo_pricing(
                    $product_ids,
                    $products,
                    $type,
                    $discount_value,
                    $settings['pricing']['preferred_cycle']
                );
            }
        }
        
        // Get TLD for Search Form - Set whenever TLDs exist!
        $tld_for_search = '';
        
        if ($show_domain_search && !empty($promo_tld_keys)) {
            // TLDs are already sorted by length and validated by WHMCS
            $tld_for_search = $promo_tld_keys[0]; // Guaranteed to be valid!
            
            whx_promo_debug("‚úì Selected TLD for search form: $code", [
                'selected_tld' => $tld_for_search,
                'all_valid_tlds' => $promo_tld_keys,
                'show_domain_search' => $show_domain_search,
            ]);
        } else {
            whx_promo_debug("‚ö†Ô∏è No TLD for search form: $code", [
                'show_domain_search' => $show_domain_search,
                'tld_keys_count' => count($promo_tld_keys),
                'promo_tlds_count' => count($promo_tlds),
            ]);
        }

        // Add to Items Array
        $items[] = [
            'code' => $code,
            'discount_val' => $discount_value,
            'discount_text' => $discount_text,
            'display_title' => $display_title,
            'description' => $final_desc,
            'expiry_raw' => $expiry,
            'expiry_ts' => $ts,
            'is_expired' => $is_expired,
            'cat_label' => $cat_label,
            'is_hot' => $is_hot,
            'ending_soon' => $ending_soon,
            'is_black_friday' => $is_black_friday,
            'link' => $link,
            'display_order' => isset($metadata['display_order']) ? intval($metadata['display_order']) : 999,
            'created_ts' => $created_ts,
            'metadata' => $metadata,
            'pricing' => $pricing_data,
            'domain_only' => $domain_only,
            'show_domain_search' => $show_domain_search,
            'tld_for_search' => $tld_for_search,
        ];
    }

    if (empty($items)) {
        return '<div class="whx-notice whx-notice--info"><p>No promotions match filters.</p></div>';
    }

    // ========================================================================
    // SORTING LOGIC
    // ========================================================================
    
    if ($atts['sort'] === 'discount_desc') {
        usort($items, function($a, $b) {
            if ($a['is_expired'] !== $b['is_expired']) return $a['is_expired'] ? 1 : -1;
            return $b['discount_val'] <=> $a['discount_val'];
        });
    } elseif ($atts['sort'] === 'expiry_asc') {
        usort($items, function($a, $b) {
            if ($a['is_expired'] !== $b['is_expired']) return $a['is_expired'] ? 1 : -1;
            return ($a['expiry_ts'] ?: PHP_INT_MAX) <=> ($b['expiry_ts'] ?: PHP_INT_MAX);
        });
    } elseif ($atts['sort'] === 'display_order') {
        usort($items, function($a, $b) {
            if ($a['is_expired'] !== $b['is_expired']) return $a['is_expired'] ? 1 : -1;
            return $a['display_order'] <=> $b['display_order'];
        });
    } else {
        usort($items, function($a, $b) {
            if ($a['is_expired'] !== $b['is_expired']) {
                return $a['is_expired'] ? 1 : -1;
            }
            if ($a['created_ts'] && $b['created_ts']) {
                return $b['created_ts'] <=> $a['created_ts'];
            }
            return $a['display_order'] <=> $b['display_order'];
        });
    }

    // ========================================================================
    // HTML OUTPUT - v9.6.0 CLEAN TLDS
    // ========================================================================
    
    ob_start();
    ?>
    <section class="whx-promo-archive" role="region" aria-label="Promotional Offers">
        <div class="whx-promo-grid">
            <?php foreach ($items as $item):
                $card_classes = ['whx-promo-card'];
                if ($item['is_expired']) $card_classes[] = 'whx-promo-card--expired';
                if ($item['ending_soon'] && !$item['is_expired']) $card_classes[] = 'whx-promo-card--ending-soon';
                if ($item['is_black_friday'] && !$item['is_expired']) $card_classes[] = 'whx-promo-card--black-friday';
                
                // Split Description into Subtitle and Body
                $description = $item['description'];
                $subtitle = '';
                if ($description) {
                    $sentences = preg_split('/(?<=[.!?])\s+/', strip_tags($description), 2);
                    if (count($sentences) > 1) {
                        $subtitle = $sentences[0];
                        $description = $sentences[1];
                    } else {
                        $subtitle = $sentences[0];
                        $description = '';
                    }
                }
            ?>
            <article class="<?php echo implode(' ', $card_classes); ?>" 
                     data-category="<?php echo esc_attr(strtolower($item['cat_label'])); ?>"
                     data-domain-only="<?php echo $item['domain_only'] ? '1' : '0'; ?>"
                     data-show-search="<?php echo $item['show_domain_search'] ? '1' : '0'; ?>"
                     data-tld="<?php echo esc_attr($item['tld_for_search']); ?>"
                     itemscope itemtype="https://schema.org/Offer">
                
                <!-- CARD HEADER SECTION -->
                <div class="whx-promo-card__header">
                    <div class="whx-promo-card__discount-badge">
                        <?php echo esc_html($item['discount_text']); ?>
                    </div>
                    
                    <h3 class="whx-promo-card__title" itemprop="name">
                        <?php echo esc_html($item['display_title']); ?>
                    </h3>
                    
                    <?php if ($subtitle): ?>
                        <p class="whx-promo-card__subtitle"><?php echo wp_kses_post($subtitle); ?></p>
                    <?php endif; ?>
                    
                    <div class="whx-promo-card__badges">
                        <?php if ($settings['badges']['enable_category_badge']): ?>
                            <span class="whx-badge whx-badge--category"><?php echo esc_html($item['cat_label']); ?></span>
                        <?php endif; ?>

                        <?php if ($item['is_black_friday'] && !$item['is_expired']): ?>
                            <span class="whx-badge whx-badge--black-friday">BLACK FRIDAY</span>
                        <?php endif; ?>

                        <?php if ($item['is_hot'] && !$item['is_expired'] && !$item['is_black_friday'] && $settings['badges']['enable_hot_badge']): ?>
                            <span class="whx-badge whx-badge--hot">LIMITED</span>
                        <?php endif; ?>

                        <?php if ($item['ending_soon'] && !$item['is_expired'] && $settings['badges']['enable_ending_soon_badge']): ?>
                            <span class="whx-badge whx-badge--soon">ENDING SOON</span>
                        <?php endif; ?>

                        <?php if ($item['is_expired'] && $settings['badges']['enable_expired_badge']): ?>
                            <span class="whx-badge whx-badge--expired">EXPIRED</span>
                        <?php endif; ?>
                    </div>
                </div>

                <!-- CARD BODY SECTION -->
                <div class="whx-promo-card__body">
                    
                    <?php if ($description): ?>
                        <p class="whx-promo-card__description"><?php echo wp_kses_post($description); ?></p>
                    <?php endif; ?>
                    
                    <!-- PRICING DISPLAY -->
                    <?php if (!empty($item['pricing'])): ?>
                        <div class="whx-promo-card__pricing">
                            <?php if (!empty($item['pricing']['price_now'])): ?>
                                <span class="whx-promo-card__price-now"><?php echo esc_html($item['pricing']['price_now']); ?></span>
                                <?php if (!empty($item['pricing']['price_period'])): ?>
                                    <span class="whx-promo-card__price-period">/<?php echo esc_html($item['pricing']['price_period']); ?></span>
                                <?php endif; ?>
                            <?php endif; ?>
                            
                            <?php if (!empty($item['pricing']['price_was']) && $item['pricing']['price_was'] !== $item['pricing']['price_now']): ?>
                                <span class="whx-promo-card__price-was"><?php echo esc_html($item['pricing']['price_was']); ?></span>
                            <?php endif; ?>
                        </div>
                    <?php endif; ?>

                    <!-- COUPON CODE DISPLAY -->
                    <div class="whx-promo-card__coupon">
                        <span class="whx-promo-card__coupon-label"><?php echo $item['is_expired'] ? 'Code:' : 'Use:'; ?></span>
                        <code class="whx-promo-card__code"><?php echo esc_html($item['code']); ?></code>
                        <?php if (!$item['is_expired']): ?>
                            <button type="button" class="whx-copy-btn" data-code="<?php echo esc_attr($item['code']); ?>" aria-label="Copy code">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </button>
                        <?php endif; ?>
                    </div>

                    <!-- EXPIRY DATE DISPLAY -->
                    <?php if ($item['expiry_raw'] && $item['expiry_raw'] !== '0000-00-00' && $item['expiry_ts']): ?>
                        <p class="whx-promo-card__expiry">
                            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            <time datetime="<?php echo esc_attr(date('Y-m-d', $item['expiry_ts'])); ?>">
                                <?php echo $item['is_expired'] ? 'Expired: ' : 'Expires: '; ?>
                                <?php echo esc_html(date_i18n('M j, Y', $item['expiry_ts'])); ?>
                            </time>
                        </p>
                    <?php endif; ?>

                    <!-- CTA BUTTON OR DOMAIN SEARCH FORM -->
                    <?php if (!$item['is_expired']): ?>
                        <?php if ($item['show_domain_search'] && !empty($item['tld_for_search'])): ?>
                            
                            <!-- ================================================ -->
                            <!-- SPACESHIP-STYLE: Single Input with Icon Inside -->
                            <!-- ================================================ -->
                            <form method="get" action="<?php echo esc_url($market_url . '/cloud/cart.php'); ?>" class="whx-domain-search-spaceship">
                                <input type="hidden" name="a" value="add">
                                <input type="hidden" name="domain" value="register">
                                <input type="hidden" name="promocode" value="<?php echo esc_attr($item['code']); ?>">
                                
                                <div class="whx-search-wrapper">
                                    <input
                                        type="text"
                                        name="search_domain"
                                        class="whx-search-input"
                                        placeholder="<?php echo count($promo_tld_keys) > 1 ? 'Search your domain' : 'Search ' . esc_attr($item['tld_for_search']) . ' domain'; ?>"
                                        required
                                        pattern="[a-zA-Z0-9\-]+"
                                        title="Enter domain name"
                                        data-tld="<?php echo esc_attr($item['tld_for_search']); ?>"
                                    >
                                    <span class="whx-tld-display">.<?php echo esc_html($item['tld_for_search']); ?></span>
                                    <button type="submit" class="whx-search-icon-btn" aria-label="Search domain">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                            <circle cx="11" cy="11" r="8"></circle>
                                            <path d="m21 21-4.35-4.35"></path>
                                        </svg>
                                    </button>
                                </div>
                            </form>
                            
                        <?php else: ?>
                            
                            <!-- ============================================ -->
                            <!-- STANDARD GET STARTED BUTTON -->
                            <!-- ============================================ -->
                            <a href="<?php echo esc_url($item['link']); ?>" class="whx-promo-card__btn" target="_blank" rel="noopener nofollow">
                                Get Started
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <path d="M5 12h14M12 5l7 7-7 7"/>
                                </svg>
                            </a>
                            
                        <?php endif; ?>
                    <?php endif; ?>
                </div>
            </article>
            <?php endforeach; ?>
        </div>
    </section>
    
    <!-- ======================================================================== -->
    <!-- INLINE JAVASCRIPT - Domain Form Handler & Copy Button -->
    <!-- ======================================================================== -->
    <script>
    (function(){
        // ========================================================================
        // v9.9.1: DIRECT CART ADD - Domain Search Handler (Opens in New Tab)
        // Submits directly to cart with sld + tld parameters (not search)
        // This ensures promocode persists through entire checkout process
        // ========================================================================
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.whx-domain-search-spaceship').forEach(function(form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();

                    var input = form.querySelector('.whx-search-input');
                    var sld = input.value.trim().replace(/[^a-z0-9\-]/gi, ''); // Clean domain name
                    var tld = input.getAttribute('data-tld');
                    var promocode = form.querySelector('input[name="promocode"]').value;

                    if (sld && tld && promocode) {
                        // Build direct cart add URL (NOT search URL!)
                        var url = form.action; // /cloud/cart.php
                        url += '?a=add';
                        url += '&domain=register';
                        url += '&sld=' + encodeURIComponent(sld);           // Domain name only
                        url += '&tld=.' + encodeURIComponent(tld);          // TLD with dot
                        url += '&promocode=' + encodeURIComponent(promocode); // Promocode persists!

                        console.log('[WHX v9.9.1] Direct cart add (new tab):', url);

                        // Open in new tab (like other buttons)
                        window.open(url, '_blank', 'noopener,noreferrer');
                    } else {
                        alert('Please enter a valid domain name');
                    }
                });
            });
        });
        
        // Copy button handler
        document.addEventListener('click', function(e) {
            var btn = e.target.closest('.whx-copy-btn');
            if (btn && navigator.clipboard) {
                var code = btn.getAttribute('data-code');
                navigator.clipboard.writeText(code).then(function() {
                    var orig = btn.innerHTML;
                    btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>';
                    btn.classList.add('whx-copy-btn--copied');
                    setTimeout(function() {
                        btn.innerHTML = orig;
                        btn.classList.remove('whx-copy-btn--copied');
                    }, 2000);
                });
            }
        });
        
        // ========================================================================
        // v9.8: WORDPRESS PROMOCODE BRIDGE
        // Captures promocode from URL and persists it across WordPress ‚Üí WHMCS
        // ========================================================================
        (function() {
            // Step 1: Check if URL has promocode parameter
            var urlParams = new URLSearchParams(window.location.search);
            var promocode = urlParams.get('promocode');
            
            if (promocode) {
                // Step 2: Store in sessionStorage (survives page navigation)
                sessionStorage.setItem('whx_promocode', promocode);
                
                // Step 3: Store in localStorage (survives browser close - 7 days)
                var expiry = new Date().getTime() + (7 * 24 * 60 * 60 * 1000); // 7 days
                localStorage.setItem('whx_promocode', JSON.stringify({
                    code: promocode,
                    expiry: expiry
                }));
                
                console.log('[WHX v9.8] Promocode captured:', promocode);
                
                // Step 4: Add promocode to all WHMCS links on the page
                document.addEventListener('DOMContentLoaded', function() {
                    var links = document.querySelectorAll('a[href*="/cloud"]');
                    
                    links.forEach(function(link) {
                        var href = link.getAttribute('href');
                        
                        // Skip if promocode already in URL
                        if (href.indexOf('promocode=') === -1) {
                            var separator = (href.indexOf('?') !== -1) ? '&' : '?';
                            link.setAttribute('href', href + separator + 'promocode=' + encodeURIComponent(promocode));
                        }
                    });
                    
                    console.log('[WHX v9.8] Added promocode to', links.length, 'WHMCS links');
                });
            }
            
            // Step 5: On WHMCS pages, check if promocode should be auto-applied
            if (window.location.pathname.indexOf('/cloud') !== -1) {
                var storedPromo = sessionStorage.getItem('whx_promocode');
                
                // Check localStorage if not in sessionStorage
                if (!storedPromo) {
                    var localData = localStorage.getItem('whx_promocode');
                    if (localData) {
                        try {
                            var parsed = JSON.parse(localData);
                            // Check if not expired
                            if (parsed.expiry > new Date().getTime()) {
                                storedPromo = parsed.code;
                                // Restore to sessionStorage
                                sessionStorage.setItem('whx_promocode', storedPromo);
                            } else {
                                // Expired - remove it
                                localStorage.removeItem('whx_promocode');
                            }
                        } catch (e) {
                            console.error('[WHX v9.8] Error parsing stored promocode:', e);
                        }
                    }
                }
                
                // If we have stored promocode and URL doesn't have one, add it
                if (storedPromo && !urlParams.get('promocode')) {
                    var newUrl = window.location.href;
                    var separator = (newUrl.indexOf('?') !== -1) ? '&' : '?';
                    
                    // Update URL without reload (preserves form state)
                    window.history.replaceState({}, '', newUrl + separator + 'promocode=' + encodeURIComponent(storedPromo));
                    
                    console.log('[WHX v9.8] Promocode auto-applied from storage:', storedPromo);
                }
            }
        })();
    })();
    </script>
    <?php
    return ob_get_clean();
}

// ============================================================================
// SECTION 6: CACHE MANAGEMENT
// ============================================================================

/**
 * Clear All Promo-Related Caches
 * v9.9.2: Added W3 Total Cache, WP Super Cache, and WP Rocket support
 */
function whx_clear_promo_cache() {
    // Clear WordPress transients
    delete_transient('whx_promos_v5');
    delete_transient('whx_products_v5_batch');
    delete_transient('whx_tlds_v5_gettldpricing');

    // Clear W3 Total Cache
    if (function_exists('w3tc_flush_all')) {
        w3tc_flush_all();
        whx_promo_debug("‚úì W3 Total Cache cleared");
    }

    // Clear WP Super Cache
    if (function_exists('wp_cache_clear_cache')) {
        wp_cache_clear_cache();
        whx_promo_debug("‚úì WP Super Cache cleared");
    }

    // Clear WP Rocket
    if (function_exists('rocket_clean_domain')) {
        rocket_clean_domain();
        whx_promo_debug("‚úì WP Rocket cache cleared");
    }

    // Clear LiteSpeed Cache
    if (class_exists('LiteSpeed_Cache_API') && method_exists('LiteSpeed_Cache_API', 'purge_all')) {
        LiteSpeed_Cache_API::purge_all();
        whx_promo_debug("‚úì LiteSpeed Cache cleared");
    }

    whx_promo_debug("Cache cleared successfully");
}

/**
 * Auto-Clear Cache on Post Save
 */
add_action('save_post', 'whx_clear_promo_cache');

/**
 * Auto-Clear Cache on Theme Switch
 */
add_action('switch_theme', 'whx_clear_promo_cache');

// ============================================================================
// END OF WHX PROMO CARDS v9.6.0 CLEAN TLDS
// ============================================================================
